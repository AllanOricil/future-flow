"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],n=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(i.push(a.value),!e||i.length!==e);n=!0);}catch(t){o=!0,r=t}finally{try{!n&&s.return&&s.return()}finally{if(o)throw r}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_get=function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,i,n)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(n):void 0},_createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var img=new Image;img.src="./bell.svg";var EventEmitter=function(){function t(){_classCallCheck(this,t),this.callbacks={}}return _createClass(t,[{key:"on",value:function(t,e){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e)}},{key:"emit",value:function(t,e){var i=this.callbacks[t];i&&i.forEach(function(t){return t(e)})}}]),t}(),Entity=function(){function r(t,e,i,n){_classCallCheck(this,r);var o=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return o.x=t,o.y=e,o.w=i,o.h=n,o.events=[],o.connections=[],o.selected=!1,o._id=+new Date+1e5*Math.random(),o}return _inherits(r,EventEmitter),_createClass(r,[{key:"addConnection",value:function(t){var e=new Connection(this,t);this.connections.push(e)}},{key:"draw",value:function(){}},{key:"contains",value:function(t,e){return t>=this.x&&t<=this.x+this.w&&e>=this.y&&e<=this.y+this.h}},{key:"area",get:function(){return this.w*this.h}},{key:"center",get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}}},{key:"sides",get:function(){return[{x:this.x+this.w/2,y:this.y,name:"top"},{x:this.x+this.w,y:this.y+this.h/2,name:"right"},{x:this.x+this.w/2,y:this.y+this.h,name:"bottom"},{x:this.x,y:this.y+this.h/2,name:"left"}]}}]),r}(),Rect=function(){function o(t,e,i,n){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,t,e,i,n))}return _inherits(o,Entity),_createClass(o,[{key:"draw",value:function(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"draw",this).call(this,e),e.fillStyle="black",e.beginPath(),e.rect(this.x,this.y,this.w,this.h),e.stroke(),Object.values(this.sides).forEach(function(t){e.beginPath(),e.strokeStyle="red",e.arc(t.x,t.y,2,0,2*Math.PI,!0),e.stroke()}),this.connections.forEach(function(t){t.draw(e),Object.values(t.closesPoints).forEach(function(t){e.beginPath(),e.strokeStyle="green",e.arc(t.x,t.y,2,0,2*Math.PI,!0),e.stroke()})})}}]),o}(),Block=function(){function r(t,e,i,n){_classCallCheck(this,r);var o=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,e,i,n));return o.header={text:"Header",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"},icon:"./bell.svg"},o.body={text:"Body",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}},o.footer={text:"Footer",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}},o}return _inherits(r,Rect),_createClass(r,[{key:"draw",value:function(e){var t=this.x+this.w,i=this.y+this.h;e.save(),e.strokeStyle="rgba(0,0,0,0.2)",e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=6,e.shadowOffsetX=6,e.shadowOffsetY=6,e.beginPath(),e.lineWidth="2",e.moveTo(this.x+5,this.y),e.lineTo(t-5,this.y),e.quadraticCurveTo(t,this.y,t,this.y+5),e.lineTo(t,this.y+this.h-5),e.quadraticCurveTo(t,i,t-5,i),e.lineTo(this.x+5,i),e.quadraticCurveTo(this.x,i,this.x,i-5),e.lineTo(this.x,this.y+5),e.quadraticCurveTo(this.x,this.y,this.x+5,this.y),e.stroke(),e.fillStyle="rgb(255,255,255)",e.fill(),e.closePath(),e.restore(),this.connections.forEach(function(t){t.draw(e)}),this.header.icon&&e.drawImage(img,this.x+15,this.y+15,25,25),e.font=this.header.font.style+" "+this.header.font.variant+" "+this.header.font.weight+" "+this.header.font.size+"px "+this.header.font.family,e.fillStyle=this.header.font.color,e.textAlign=this.header.alignment,e.fillText(this.header.text,this.x+55,this.y+36),e.save(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth="1",e.beginPath(),e.moveTo(this.x,this.y+50),e.lineTo(this.x+this.w,this.y+50),e.stroke(),e.closePath(),e.restore(),e.font=this.body.font.style+" "+this.body.font.variant+" "+this.body.font.weight+" "+this.body.font.size+"px "+this.body.font.family,e.fillStyle=this.body.font.color,e.textAlign=this.body.alignment,e.fillText(this.body.text,this.x+15,this.y+75),e.font=this.footer.font.style+" "+this.footer.font.variant+" "+this.footer.font.weight+" "+this.footer.font.size+"px "+this.footer.font.family,e.fillStyle=this.footer.font.color,e.textAlign=this.footer.alignment,e.fillText(this.footer.text,this.x+15,this.y+175),e.save(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth="1",e.beginPath(),e.moveTo(this.x,this.y+150),e.lineTo(this.x+this.w,this.y+150),e.stroke(),e.closePath(),e.restore(),this.w=e.measureText(this.header.text).width+75,this.h=200}}]),r}(),Connection=function(){function n(t,e){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t.x,t.y));return i.from=t,i.to=e,i}return _inherits(n,Entity),_createClass(n,[{key:"draw",value:function(e){if(e.save(),e.beginPath(),e.moveTo(this.from.x+this.from.w/2,this.from.y+this.from.h/2),e.lineTo(this.to.x+this.to.w/2,this.to.y+this.to.h/2),e.strokeStyle="blue",e.stroke(),e.restore(),0<this.path.length){e.lineWidth="2",e.strokeStyle="rgb(200,200,200)",e.beginPath(),e.moveTo(this.path[0].x,this.path[0].y),this.path.forEach(function(t){e.lineTo(Math.ceil(t.x),Math.ceil(t.y)),e.stroke()}),e.closePath();var t=this.path[this.path.length-1],i=this.path[this.path.length-2];t.x==i.x?t.y>i.y?(e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+10,t.y-10),e.lineTo(t.x-10,t.y-10)):(e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x-10,t.y+10),e.lineTo(t.x+10,t.y+10)):t.x>i.x?(e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x-10,t.y-10),e.lineTo(t.x-10,t.y+10)):(e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+10,t.y-10),e.lineTo(t.x+10,t.y+10)),e.fillStyle="rgb(200,200,200)",e.fill(),e.closePath()}}},{key:"closesPoints",get:function(){var t=this,n=1/0,o={};return this.from.sides.forEach(function(i){t.to.sides.forEach(function(t){var e=Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2));e<n&&(n=e,o={from:i,to:t})})}),o}},{key:"path",get:function(){var t=this.closesPoints,e=t.from,i=t.to,n=Math.abs(i.x-e.x)/2,o=Math.abs(i.y-e.y)/2,r=[];return"left"===e.name&&"right"===i.name||"right"===e.name&&"left"===i.name?(e.x>i.x&&(n*=-1),r.push({x:e.x,y:e.y},{x:e.x+n,y:e.y},{x:i.x-n,y:i.y},{x:i.x,y:i.y})):"bottom"!==e.name&&"top"!==e.name||"right"!==i.name&&"left"!==i.name?"right"!==e.name&&"left"!==e.name||"top"!==i.name&&"bottom"!==i.name?("top"===e.name&&"bottom"===i.name||"bottom"===e.name&&"top"===i.name)&&(e.y>i.y&&(o*=-1),r.push({x:e.x,y:e.y},{x:e.x,y:e.y+o},{x:i.x,y:i.y-o},{x:i.x,y:i.y})):r.push({x:e.x,y:e.y},{x:i.x,y:e.y},{x:i.x,y:i.y}):r.push({x:e.x,y:e.y},{x:e.x,y:i.y},{x:i.x,y:i.y}),r}}]),n}(),Graph=function(){function e(t){_classCallCheck(this,e),this.rects=t}return _createClass(e,[{key:"rects2JSON",get:function(){return JSON.parse(this.rects)}}]),e}(),Canvas=function(){function s(t,e){var h=this,i=e.w,n=e.h,o=e.scaleLimits;_classCallCheck(this,s),this.isDrawing=!1,this.el=t,this.el.width=i||400,this.el.height=n||400,this.origin={x:0,y:0},this.entities={},this._isDraggingCanvas=!1,this.isDebugging=!0,this.drawOrigin=!1,this.scaleLimits=o||{max:s.MAX_SCALE(),min:s.MIN_SCALE()};var r={horizontal:1,vertical:1};this.getScale=function(){return r},this.setScale=function(t,e){console.log(h.scaleLimits);var i=r.horizontal*t,n=r.vertical*e;console.log(i),i<h.scaleLimits.max&&n<h.scaleLimits.max&&i>=h.scaleLimits.min&&n>=h.scaleLimits.min&&(r={horizontal:i,vertical:n})};var c=[],a=null,y=!1;this.el.addEventListener("mousemove",function(t){if(h._isDraggingCanvas)h.translate(t.movementX,t.movementY);else if(a){y=!0;var e=(t.x-h.origin.x)/h.getScale().horizontal,i=(t.y-h.origin.y)/h.getScale().vertical;a.x=e-a.w/2,a.y=i-a.h/2}}),this.el.addEventListener("dblclick",function(t){var e=(t.x-h.origin.x)/h.getScale().horizontal,i=(t.y-h.origin.y)/h.getScale().vertical;h.addEntity(new Block(e,i,100,100))}),this.el.addEventListener("click",function(t){var s=(t.x-h.origin.x)/h.getScale().horizontal,l=(t.y-h.origin.y)/h.getScale().vertical;if(y)y=!1;else{for(var e=function(t){var e=h.entitiesArray[t];if(e.contains(s,l)){if(0===c.length?c.push(e):c.forEach(function(t){t._id!==e._id&&c.push(e)}),2==c.length){for(var i=c.pop(),n=c.pop(),o=!1,r=0;r<n.connections.length;r++){if(n.connections[r].to._id===i._id){o=!0;break}}for(var a=0;a<i.connections.length;a++){if(i.connections[a].to._id===n._id){o=!0;break}}o||n.addConnection(i),c=[]}return{v:void 0}}},i=0;i<h.entitiesArray.length;i++){var n=e(i);if("object"===(void 0===n?"undefined":_typeof(n)))return n.v}c=[]}}),this.el.addEventListener("mousedown",function(t){for(var e=(t.x-h.origin.x)/h.getScale().horizontal,i=(t.y-h.origin.y)/h.getScale().vertical,n=0;n<h.entitiesArray.length;n++){var o=h.entitiesArray[n];if(o.contains(e,i))return void(a=a||o)}h._isDraggingCanvas=!0}),this.el.addEventListener("mouseup",function(t){h._isDraggingCanvas=!1,a=a&&null}),this.el.addEventListener("wheel",function(t){0<t.wheelDelta?h.setScale(1.01,1.01):h.setScale(.99,.99)}),this.start()}return _createClass(s,null,[{key:"MAX_SCALE",value:function(){return 2}},{key:"MIN_SCALE",value:function(){return.2}}]),_createClass(s,[{key:"start",value:function(){var e=this;setInterval(function(){e.isDrawing?(console.log("DRAWING"),e.clear(),e.isDebugging&&e.drawOrigin&&(e.ctx.moveTo(e.origin.x,e.origin.y),e.ctx.lineTo(e.origin.x,e.origin.y+e.el.height),e.ctx.moveTo(e.origin.x,e.origin.y),e.ctx.lineTo(e.origin.x+e.el.width,e.origin.y),e.ctx.moveTo(e.origin.x,e.origin.y),e.ctx.lineTo(e.origin.x-e.el.width,e.origin.y),e.ctx.moveTo(e.origin.x,e.origin.y),e.ctx.lineTo(e.origin.x,e.origin.y-e.el.height),e.ctx.stroke()),e.ctx.save(),e.ctx.translate(e.origin.x,e.origin.y),e.ctx.scale(e.getScale().horizontal,e.getScale().vertical),Object.values(e.entities).forEach(function(t){t.draw(e.ctx)}),e.ctx.restore()):console.log("PAUSED")},1e3/60)}},{key:"resize",value:function(t,e){this.el.width=t,this.el.height=e}},{key:"addEntity",value:function(t){this.entities[t._id]=t}},{key:"removeEntity",value:function(t){delete this.entities[t._id]}},{key:"clear",value:function(){this.ctx.clearRect(0,0,canvas.width,canvas.height)}},{key:"translate",value:function(t,e){this.origin.x+=t,this.origin.y+=e}},{key:"setData",value:function(t){var i={};if(t&&t.blocks&&0<Object.values(t.blocks).length){var e=!0,n=!1,o=void 0;try{for(var r,a=Object.entries(t.blocks)[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var s=r.value,l=_slicedToArray(s,2),h=l[0],c=l[1];if(c){var y=new Block(c.x||50,c.y||50,100,100);this.addEntity(y),i[h]=y}}}catch(t){n=!0,o=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw o}}var f=function(e,t){t&&t.connections&&t.connections.forEach(function(t){i[t]&&i[e].addConnection(i[t])})},u=!0,g=!1,x=void 0;try{for(var v,d=Object.entries(t.blocks)[Symbol.iterator]();!(u=(v=d.next()).done);u=!0){var m=v.value,b=_slicedToArray(m,2);f(b[0],b[1])}}catch(t){g=!0,x=t}finally{try{!u&&d.return&&d.return()}finally{if(g)throw x}}}this.isDrawing=!0}},{key:"ctx",get:function(){return this.el.getContext("2d")}},{key:"entitiesArray",get:function(){return Object.values(this.entities)}}]),s}();function initCanvas(t){var e=t||document.getElementById("canvas"),i=new Canvas(e,{w:window.innerWidth,h:window.innerHeight});window.addEventListener("resize",function(){i.resize(window.innerWidth,window.innerHeight)},!1);i.setData({blocks:{a:{x:50,y:50,connections:["b","c"],header:{text:"Header",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"},icon:"./bell.svg"},body:{text:"Body",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}},footer:{text:"Footer",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}}},b:{x:400,y:400,connections:["c"],header:{text:"Header",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"},icon:"./bell.svg"},body:{text:"Body",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}},footer:{text:"Footer",alignment:"start",font:{family:"Arial",style:"normal",variant:"normal",color:"rgba(0,0,0,0.6)",size:20,weight:"bold"}}},c:{x:700,y:800,connections:["a"]}}}),console.log(i)}